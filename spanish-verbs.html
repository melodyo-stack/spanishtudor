<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spanish Verb Tutor</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Learn Spanish verb conjugations and direct object pronouns with Hello Kitty!">
    <meta name="theme-color" content="#ff6b9d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spanish Tutor">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/Hello_Kitty.webp">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ff6b9d 0%, #c06c84 50%, #f67280 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 30px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 5px solid #fff;
        }

        .welcome-screen {
            text-align: center;
        }

        .welcome-screen h1 {
            color: #ff6b9d;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .welcome-screen img {
            max-width: 250px;
            height: auto;
            margin: 30px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .welcome-screen select {
            padding: 15px 30px;
            font-size: 20px;
            border: 3px solid #ff6b9d;
            border-radius: 25px;
            background: white;
            color: #ff6b9d;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-family: inherit;
        }

        .welcome-screen button {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background: #ff6b9d;
            color: white;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
            transition: all 0.3s;
        }

        .welcome-screen button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 107, 157, 0.4);
        }

        .mode-selection {
            text-align: center;
        }

        .mode-selection h2 {
            color: #ff6b9d;
            font-size: 36px;
            margin-bottom: 30px;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 40px;
        }

        .mode-btn {
            padding: 25px;
            font-size: 22px;
            font-weight: bold;
            border: 4px solid #ff6b9d;
            border-radius: 20px;
            cursor: pointer;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #2d3436;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.pronouns {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
        }

        .back-btn {
            margin-top: 30px;
            padding: 12px 30px;
            background: #dfe6e9;
            color: #2d3436;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .back-btn:hover {
            background: #b2bec3;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        .student-selector {
            text-align: center;
            margin-bottom: 30px;
        }

        .student-selector select {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .student-selector select:focus {
            outline: none;
            border-color: #5568d3;
        }

        .quiz-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .question {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .pronoun {
            font-weight: bold;
            color: #667eea;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn {
            background: #667eea;
            color: white;
        }

        .submit-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .skip-btn {
            background: #e0e0e0;
            color: #666;
        }

        .skip-btn:hover {
            background: #d0d0d0;
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }

        .feedback img {
            max-width: 100px;
            height: auto;
            margin-top: 10px;
        }

        .correct {
            background: #d4edda;
            color: #155724;
        }

        .incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .partial {
            background: #fff3cd;
            color: #856404;
        }

        .results img {
            max-width: 200px;
            height: auto;
            margin: 20px auto;
            display: block;
        }

        .progress {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .results {
            text-align: center;
        }

        .score {
            font-size: 48px;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
        }

        .gaps {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .gaps h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .gap-item {
            margin: 10px 0;
            color: #333;
        }

        .restart-btn {
            background: #28a745;
            color: white;
            width: 100%;
        }

        .restart-btn:hover {
            background: #218838;
        }

        .review-btn {
            background: #667eea;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .review-btn:hover {
            background: #5568d3;
        }

        .transition-screen {
            text-align: center;
            padding: 40px;
        }

        .transition-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .transition-screen p {
            font-size: 18px;
            margin: 15px 0;
            color: #333;
        }

        .transition-screen .score-summary {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
        }

        .continue-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        .continue-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="welcome-screen">
            <h1>¬°Hola!</h1>
            <img src="images/Hello_Kitty.webp" alt="Hello Kitty">
            <h2 style="color: #ff6b9d; margin-bottom: 20px;">Welcome to Spanish Learning!</h2>
            <p style="font-size: 18px; color: #666; margin-bottom: 10px;">Who's learning today?</p>
            <select id="student-select-welcome">
                <option value="">-- Choose Your Name --</option>
                <option value="Melody">Melody</option>
                <option value="Jared">Jared</option>
                <option value="Lainie">Lainie</option>
                <option value="Ryder">Ryder</option>
                <option value="SmallSetTesting">Small Set Testing</option>
            </select>
            <br>
            <button onclick="selectStudent()">Let's Learn!</button>
        </div>

        <!-- Mode Selection Screen -->
        <div id="mode-screen" class="mode-selection" style="display: none;">
            <h2>What do you want to practice?</h2>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="startQuiz('verbs')" style="text-align: left; padding: 20px;">
                    <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">üåü Present Tense Irregular Verbs üåü</div>
                    <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">Practice conjugating irregular verbs like ser, estar, ir, tener (I am, you go, he has...)</div>
                </button>
                <button class="mode-btn pronouns" onclick="startQuiz('pronouns')" style="text-align: left; padding: 20px;">
                    <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">‚ú® Direct Object Pronouns ‚ú®</div>
                    <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">Who/what receives the action: me, te, lo, la, nos, los, las (I see him ‚Üí lo veo)</div>
                </button>
                <button class="mode-btn" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; text-align: left; padding: 20px;" onclick="startQuiz('indirect')">
                    <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">üí´ Indirect Object Pronouns üí´</div>
                    <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">To/for whom the action is done: me, te, le, nos, les (I give to her ‚Üí le doy)</div>
                </button>
                <button class="mode-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #c44569 100%); color: white; text-align: left; padding: 20px;" onclick="startQuiz('advanced')">
                    <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">üî• Advanced - Mixed Challenge üî•</div>
                    <div style="font-size: 14px; font-weight: normal; opacity: 0.9;">Mix of all topics: verbs, direct + indirect pronouns combined (He gives it to me ‚Üí me lo da)</div>
                </button>
            </div>
            <button class="back-btn" onclick="backToWelcome()">‚Üê Change Student</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" style="display: none;">
            <h1 style="color: #ff6b9d;">Spanish Tutor</h1>
            <p class="subtitle" id="subtitle">Present Tense Irregular Verbs</p>
            <button class="back-btn" onclick="backToModeSelection()" style="margin-bottom: 20px;">‚Üê Back to Menu</button>

            <div id="quiz">
            <div class="progress">
                Question <span id="current">1</span> of <span id="total"></span>
            </div>

            <div class="quiz-card">
                <div class="question">
                    <span class="pronoun" id="pronoun">yo</span>
                    <span id="verb">(ser)</span>
                    <div style="color: #888; font-size: 16px; margin-top: 8px;" id="english">to be</div>
                </div>
                <input type="text" id="answer" placeholder="Type the conjugation..." autocomplete="off" tabindex="1">
                <div class="buttons">
                    <button class="submit-btn" id="submit-btn" onclick="checkAnswer()" tabindex="2">Submit</button>
                    <button class="skip-btn" id="skip-btn" onclick="skipQuestion()" tabindex="3">Skip</button>
                    <button class="submit-btn" id="next-btn" onclick="nextQuestion()" style="display: none;" tabindex="2">Next Question</button>
                </div>
                <div id="feedback"></div>
            </div>
        </div>

        <div id="transition" style="display: none;">
            <div class="transition-screen">
                <h2 id="transition-title">Great Job!</h2>
                <div class="score-summary" id="transition-score">80%</div>
                <img src="images/Kuromi_render.png" alt="Kuromi" style="max-width: 200px; height: auto; margin: 20px auto; display: block;">
                <p id="transition-message">You answered 24 out of 30 questions correctly!</p>
                <p id="transition-review-info">Let's review the 6 questions you missed.</p>
                <button class="continue-btn" onclick="startReview()">Start Review</button>
            </div>
        </div>

        <div id="results" style="display: none;">
            <div class="results">
                <h2 id="results-title">Quiz Complete!</h2>
                <div class="score" id="score"></div>
                <p id="results-message">You got <span id="correct-count">0</span> correct out of <span id="question-count"></span></p>

                <div class="gaps" id="gaps-section" style="display: none;">
                    <h3>Areas to Practice:</h3>
                    <div id="gaps-list"></div>
                </div>

                <button class="restart-btn" onclick="restartQuiz()">Take Quiz Again</button>
                <button class="review-btn" id="review-again-btn" onclick="reviewAgain()" style="display: none;">Review Mistakes Again</button>
            </div>
        </div>

        <!-- Graph Page -->
        <div id="graph-page" style="display: none;">
            <div class="results">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìä Your Score Progress</h2>
                <canvas id="scoreChart" style="max-width: 600px; margin: 20px auto;"></canvas>
                <div id="graph-stats" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;"></div>
                <button class="back-btn" onclick="backToResults()" style="margin-top: 20px;">‚Üê Back to Results</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        const irregularVerbs = [
            { verb: 'ser', english: 'to be', yo: 'soy', t√∫: 'eres', √©l: 'es', nosotros: 'somos', ellos: 'son' },
            { verb: 'estar', english: 'to be', yo: 'estoy', t√∫: 'est√°s', √©l: 'est√°', nosotros: 'estamos', ellos: 'est√°n' },
            { verb: 'ir', english: 'to go', yo: 'voy', t√∫: 'vas', √©l: 'va', nosotros: 'vamos', ellos: 'van' },
            { verb: 'tener', english: 'to have', yo: 'tengo', t√∫: 'tienes', √©l: 'tiene', nosotros: 'tenemos', ellos: 'tienen' },
            { verb: 'hacer', english: 'to do/make', yo: 'hago', t√∫: 'haces', √©l: 'hace', nosotros: 'hacemos', ellos: 'hacen' },
            { verb: 'decir', english: 'to say/tell', yo: 'digo', t√∫: 'dices', √©l: 'dice', nosotros: 'decimos', ellos: 'dicen' },
            { verb: 'poder', english: 'to be able/can', yo: 'puedo', t√∫: 'puedes', √©l: 'puede', nosotros: 'podemos', ellos: 'pueden' },
            { verb: 'poner', english: 'to put/place', yo: 'pongo', t√∫: 'pones', √©l: 'pone', nosotros: 'ponemos', ellos: 'ponen' },
            { verb: 'saber', english: 'to know', yo: 's√©', t√∫: 'sabes', √©l: 'sabe', nosotros: 'sabemos', ellos: 'saben' },
            { verb: 'venir', english: 'to come', yo: 'vengo', t√∫: 'vienes', √©l: 'viene', nosotros: 'venimos', ellos: 'vienen' },
            { verb: 'querer', english: 'to want', yo: 'quiero', t√∫: 'quieres', √©l: 'quiere', nosotros: 'queremos', ellos: 'quieren' },
            { verb: 'dar', english: 'to give', yo: 'doy', t√∫: 'das', √©l: 'da', nosotros: 'damos', ellos: 'dan' },
            { verb: 'ver', english: 'to see', yo: 'veo', t√∫: 'ves', √©l: 've', nosotros: 'vemos', ellos: 'ven' },
            { verb: 'salir', english: 'to leave/go out', yo: 'salgo', t√∫: 'sales', √©l: 'sale', nosotros: 'salimos', ellos: 'salen' },
            { verb: 'traer', english: 'to bring', yo: 'traigo', t√∫: 'traes', √©l: 'trae', nosotros: 'traemos', ellos: 'traen' },
            { verb: 'caer', english: 'to fall', yo: 'caigo', t√∫: 'caes', √©l: 'cae', nosotros: 'caemos', ellos: 'caen' },
            { verb: 'conocer', english: 'to know/meet', yo: 'conozco', t√∫: 'conoces', √©l: 'conoce', nosotros: 'conocemos', ellos: 'conocen' },
            { verb: 'o√≠r', english: 'to hear', yo: 'oigo', t√∫: 'oyes', √©l: 'oye', nosotros: 'o√≠mos', ellos: 'oyen' },
            { verb: 'seguir', english: 'to follow', yo: 'sigo', t√∫: 'sigues', √©l: 'sigue', nosotros: 'seguimos', ellos: 'siguen' }
        ];

        // Direct object pronoun questions
        const pronounQuestions = [
            { sentence: 'I see it (masculine)', verb: 'ver', answer: 'lo veo' },
            { sentence: 'I see it (feminine)', verb: 'ver', answer: 'la veo' },
            { sentence: 'You have them (feminine)', verb: 'tener', answer: 'las tienes' },
            { sentence: 'He buys it (masculine)', verb: 'comprar', answer: 'lo compra' },
            { sentence: 'She knows them (masculine)', verb: 'conocer', answer: 'los conoce' },
            { sentence: 'We see her', verb: 'ver', answer: 'la vemos' },
            { sentence: 'We see him', verb: 'ver', answer: 'lo vemos' },
            { sentence: 'They help me', verb: 'ayudar', answer: 'me ayudan' },
            { sentence: 'You all visit us', verb: 'visitar', answer: 'nos visitan' },
            { sentence: 'I call you (t√∫)', verb: 'llamar', answer: 'te llamo' },
            { sentence: 'She loves him', verb: 'amar', answer: 'lo ama' },
            { sentence: 'We know them (feminine)', verb: 'conocer', answer: 'las conocemos' },
            { sentence: 'He sees them (masculine)', verb: 'ver', answer: 'los ve' },
            { sentence: 'I want it (feminine)', verb: 'querer', answer: 'la quiero' },
            { sentence: 'They invite me', verb: 'invitar', answer: 'me invitan' },
            { sentence: 'You understand us', verb: 'entender', answer: 'nos entiendes' },
            { sentence: 'She reads it (masculine)', verb: 'leer', answer: 'lo lee' },
            { sentence: 'We hear them (feminine)', verb: 'o√≠r', answer: 'las o√≠mos' },
            { sentence: 'I love you (t√∫)', verb: 'amar', answer: 'te amo' },
            { sentence: 'He teaches us', verb: 'ense√±ar', answer: 'nos ense√±a' },
            { sentence: 'They visit me', verb: 'visitar', answer: 'me visitan' },
            { sentence: 'I see them (masculine)', verb: 'ver', answer: 'los veo' },
            { sentence: 'She wants it (masculine)', verb: 'querer', answer: 'lo quiere' },
            { sentence: 'You know me', verb: 'conocer', answer: 'me conoces' },
            { sentence: 'He brings them (feminine)', verb: 'traer', answer: 'las trae' },
            { sentence: 'I see you (Usted, masculine)', verb: 'ver', answer: 'lo veo' },
            { sentence: 'She loves you (Usted, masculine)', verb: 'amar', answer: 'lo ama' },
            { sentence: 'They know you (Usted, feminine)', verb: 'conocer', answer: 'la conocen' }
        ];

        // Indirect object pronoun questions
        const indirectPronounQuestions = [
            { sentence: 'I give to him/her', verb: 'dar', answer: 'le doy' },
            { sentence: 'I give to them', verb: 'dar', answer: 'les doy' },
            { sentence: 'You send to me', verb: 'enviar', answer: 'me env√≠as' },
            { sentence: 'He writes to us', verb: 'escribir', answer: 'nos escribe' },
            { sentence: 'She tells to you (t√∫)', verb: 'decir', answer: 'te dice' },
            { sentence: 'We bring to him/her', verb: 'traer', answer: 'le traemos' },
            { sentence: 'They show to me', verb: 'mostrar', answer: 'me muestran' },
            { sentence: 'I explain to them', verb: 'explicar', answer: 'les explico' },
            { sentence: 'You buy for me', verb: 'comprar', answer: 'me compras' },
            { sentence: 'He gives to us', verb: 'dar', answer: 'nos da' },
            { sentence: 'She sends to you (t√∫)', verb: 'enviar', answer: 'te env√≠a' },
            { sentence: 'We tell to him/her', verb: 'decir', answer: 'le decimos' },
            { sentence: 'They write to me', verb: 'escribir', answer: 'me escriben' },
            { sentence: 'I ask to you (t√∫)', verb: 'preguntar', answer: 'te pregunto' },
            { sentence: 'You give to them', verb: 'dar', answer: 'les das' },
            { sentence: 'He teaches to us', verb: 'ense√±ar', answer: 'nos ense√±a' },
            { sentence: 'She brings to me', verb: 'traer', answer: 'me trae' },
            { sentence: 'We send to him/her', verb: 'enviar', answer: 'le enviamos' },
            { sentence: 'They offer to you (t√∫)', verb: 'ofrecer', answer: 'te ofrecen' },
            { sentence: 'I recommend to them', verb: 'recomendar', answer: 'les recomiendo' },
            { sentence: 'You explain to me', verb: 'explicar', answer: 'me explicas' },
            { sentence: 'He says to us', verb: 'decir', answer: 'nos dice' },
            { sentence: 'She gives to you (t√∫)', verb: 'dar', answer: 'te da' },
            { sentence: 'We ask to him/her', verb: 'preguntar', answer: 'le preguntamos' },
            { sentence: 'They show to me', verb: 'mostrar', answer: 'me muestran' },
            { sentence: 'I lend to you (t√∫)', verb: 'prestar', answer: 'te presto' },
            { sentence: 'You promise to them', verb: 'prometer', answer: 'les prometes' },
            { sentence: 'He gives to me', verb: 'dar', answer: 'me da' }
        ];

        // Mixed direct and indirect object pronoun questions (ADVANCED)
        const mixedPronounQuestions = [
            { sentence: 'He gives it (masc.) to me', verb: 'dar', answer: 'me lo da' },
            { sentence: 'I give it (fem.) to you (t√∫)', verb: 'dar', answer: 'te la doy' },
            { sentence: 'She sends them (masc.) to us', verb: 'enviar', answer: 'nos los env√≠a' },
            { sentence: 'You give it (masc.) to him/her', verb: 'dar', answer: 'se lo das' },
            { sentence: 'We show it (fem.) to them', verb: 'mostrar', answer: 'se la mostramos' },
            { sentence: 'They tell it (masc.) to me', verb: 'decir', answer: 'me lo dicen' },
            { sentence: 'I send them (fem.) to you (t√∫)', verb: 'enviar', answer: 'te las env√≠o' },
            { sentence: 'He brings it (masc.) to us', verb: 'traer', answer: 'nos lo trae' },
            { sentence: 'She gives them (masc.) to him/her', verb: 'dar', answer: 'se los da' },
            { sentence: 'You write it (fem.) to me', verb: 'escribir', answer: 'me la escribes' },
            { sentence: 'We bring it (masc.) to you (t√∫)', verb: 'traer', answer: 'te lo traemos' },
            { sentence: 'They give it (fem.) to us', verb: 'dar', answer: 'nos la dan' },
            { sentence: 'I explain it (masc.) to them', verb: 'explicar', answer: 'se lo explico' },
            { sentence: 'You send it (fem.) to him/her', verb: 'enviar', answer: 'se la env√≠as' },
            { sentence: 'He shows them (fem.) to me', verb: 'mostrar', answer: 'me las muestra' },
            { sentence: 'She tells it (masc.) to you (t√∫)', verb: 'decir', answer: 'te lo dice' },
            { sentence: 'We give them (masc.) to them', verb: 'dar', answer: 'se los damos' },
            { sentence: 'They bring it (fem.) to me', verb: 'traer', answer: 'me la traen' },
            { sentence: 'I offer it (masc.) to you (t√∫)', verb: 'ofrecer', answer: 'te lo ofrezco' },
            { sentence: 'You recommend them (fem.) to us', verb: 'recomendar', answer: 'nos las recomiendas' },
            { sentence: 'He gives it (fem.) to them', verb: 'dar', answer: 'se la da' },
            { sentence: 'She sends it (masc.) to me', verb: 'enviar', answer: 'me lo env√≠a' },
            { sentence: 'We show it (masc.) to him/her', verb: 'mostrar', answer: 'se lo mostramos' },
            { sentence: 'They give them (fem.) to you (t√∫)', verb: 'dar', answer: 'te las dan' }
        ];

        const pronouns = ['yo', 't√∫', '√©l', 'nosotros', 'ellos'];
        let questions = [];
        let currentQuestion = 0;
        let score = 0;
        let mistakes = [];
        let currentStudent = 'Melody';
        let reviewMode = false;
        let reviewQuestions = [];
        let masteryTracker = {}; // Track how many times each mistake was answered correctly
        let initialScore = 0; // Track score from first 30 questions
        let savedMistakesForReview = []; // Save mistakes for potential re-review
        let quizSize = 30; // Default quiz size
        let quizMode = 'verbs'; // 'verbs' or 'pronouns'

        // Get quiz size for student
        function getQuizSize(studentName) {
            return studentName === 'SmallSetTesting' ? 3 : 10;
        }

        // Load student data from localStorage
        function loadStudentData(studentName) {
            const saved = localStorage.getItem(`spanish-tutor-${studentName}-${quizMode}`);
            if (saved) {
                const data = JSON.parse(saved);
                mistakes = data.mistakes || [];
            } else {
                mistakes = [];
            }
            quizSize = getQuizSize(studentName);
        }

        // Save student data to localStorage
        function saveStudentData(studentName) {
            const data = {
                mistakes: mistakes,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem(`spanish-tutor-${studentName}-${quizMode}`, JSON.stringify(data));
        }

        // Save quiz score history
        function saveScoreHistory(studentName, score, total) {
            const key = `spanish-tutor-scores-${studentName}-${quizMode}`;
            const saved = localStorage.getItem(key);
            let scores = saved ? JSON.parse(saved) : [];

            scores.push({
                score: score,
                total: total,
                percentage: Math.round((score / total) * 100),
                date: new Date().toISOString(),
                timestamp: Date.now()
            });

            // Keep only last 20 scores
            if (scores.length > 20) {
                scores = scores.slice(-20);
            }

            localStorage.setItem(key, JSON.stringify(scores));
        }

        // Get score history
        function getScoreHistory(studentName) {
            const key = `spanish-tutor-scores-${studentName}-${quizMode}`;
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : [];
        }

        // Navigation functions
        function selectStudent() {
            const select = document.getElementById('student-select-welcome');
            if (!select.value) {
                alert('Please choose your name!');
                return;
            }
            currentStudent = select.value;
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('mode-screen').style.display = 'block';
        }

        function backToWelcome() {
            document.getElementById('mode-screen').style.display = 'none';
            document.getElementById('welcome-screen').style.display = 'block';
        }

        function backToModeSelection() {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('mode-screen').style.display = 'block';
        }

        function startQuiz(mode) {
            quizMode = mode;

            // Update subtitle
            if (quizMode === 'verbs') {
                document.getElementById('subtitle').textContent = 'üåü Present Tense Irregular Verbs üåü';
            } else if (quizMode === 'pronouns') {
                document.getElementById('subtitle').textContent = '‚ú® Direct Object Pronouns ‚ú®';
            } else if (quizMode === 'indirect') {
                document.getElementById('subtitle').textContent = 'üí´ Indirect Object Pronouns üí´';
            } else {
                document.getElementById('subtitle').textContent = 'üî• Advanced - Mixed Challenge üî•';
            }

            // Load student data and start quiz
            loadStudentData(currentStudent);
            currentQuestion = 0;
            score = 0;
            reviewMode = false;
            generateQuestions();

            document.getElementById('mode-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
            document.getElementById('quiz').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('transition').style.display = 'none';
            displayQuestion();
        }

        function generateQuestions() {
            questions = [];
            mistakes = []; // Clear old mistakes to ensure fresh quiz every time

            if (quizMode === 'verbs') {
                // Create a pool of all possible verb-pronoun combinations
                const allCombinations = [];
                irregularVerbs.forEach(verbObj => {
                    pronouns.forEach(pronoun => {
                        allCombinations.push({
                            verb: verbObj.verb,
                            english: verbObj.english,
                            pronoun: pronoun,
                            answer: verbObj[pronoun],
                            type: 'verb'
                        });
                    });
                });

                // Shuffle and select questions based on quiz size
                const shuffled = allCombinations.sort(() => Math.random() - 0.5);
                questions = shuffled.slice(0, quizSize);
            } else if (quizMode === 'pronouns') {
                // Direct object pronouns mode
                const shuffled = pronounQuestions.sort(() => Math.random() - 0.5);
                questions = shuffled.slice(0, quizSize).map(q => ({
                    sentence: q.sentence,
                    verb: q.verb,
                    answer: q.answer,
                    type: 'pronoun'
                }));
            } else if (quizMode === 'indirect') {
                // Indirect object pronouns mode
                const shuffled = indirectPronounQuestions.sort(() => Math.random() - 0.5);
                questions = shuffled.slice(0, quizSize).map(q => ({
                    sentence: q.sentence,
                    verb: q.verb,
                    answer: q.answer,
                    type: 'indirect'
                }));
            } else {
                // Advanced mode - mix of all question types
                const allQuestions = [];

                // Add some verb conjugations
                const verbCombos = [];
                irregularVerbs.forEach(verbObj => {
                    pronouns.forEach(pronoun => {
                        verbCombos.push({
                            verb: verbObj.verb,
                            english: verbObj.english,
                            pronoun: pronoun,
                            answer: verbObj[pronoun],
                            type: 'verb'
                        });
                    });
                });
                const shuffledVerbs = verbCombos.sort(() => Math.random() - 0.5).slice(0, Math.floor(quizSize / 4));
                allQuestions.push(...shuffledVerbs);

                // Add some direct object pronouns
                const shuffledDirect = pronounQuestions.sort(() => Math.random() - 0.5).slice(0, Math.floor(quizSize / 4));
                allQuestions.push(...shuffledDirect.map(q => ({
                    sentence: q.sentence,
                    verb: q.verb,
                    answer: q.answer,
                    type: 'pronoun'
                })));

                // Add some indirect object pronouns
                const shuffledIndirect = indirectPronounQuestions.sort(() => Math.random() - 0.5).slice(0, Math.floor(quizSize / 4));
                allQuestions.push(...shuffledIndirect.map(q => ({
                    sentence: q.sentence,
                    verb: q.verb,
                    answer: q.answer,
                    type: 'indirect'
                })));

                // Add mixed direct + indirect pronouns
                const shuffledMixed = mixedPronounQuestions.sort(() => Math.random() - 0.5).slice(0, Math.floor(quizSize / 4));
                allQuestions.push(...shuffledMixed.map(q => ({
                    sentence: q.sentence,
                    verb: q.verb,
                    answer: q.answer,
                    type: 'mixed'
                })));

                // Shuffle all questions together and trim to exact quiz size
                questions = allQuestions.sort(() => Math.random() - 0.5).slice(0, quizSize);
            }
        }

        function displayQuestion() {
            if (currentQuestion >= questions.length) {
                if (!reviewMode && mistakes.length > 0) {
                    // Show transition screen before review
                    showTransitionScreen();
                } else {
                    showResults();
                }
                return;
            }

            const q = questions[currentQuestion];

            if (quizMode === 'verbs') {
                document.getElementById('pronoun').textContent = q.pronoun;
                document.getElementById('verb').textContent = `(${q.verb})`;
                document.getElementById('english').textContent = q.english;
            } else {
                // Pronoun mode (both direct and indirect)
                document.getElementById('pronoun').textContent = q.sentence;
                document.getElementById('verb').textContent = `Verb: ${q.verb}`;
                document.getElementById('english').textContent = '';
            }

            document.getElementById('answer').value = '';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('current').textContent = currentQuestion + 1;
            document.getElementById('total').textContent = questions.length;
            document.getElementById('answer').focus();

            // Reset buttons
            document.getElementById('submit-btn').style.display = 'inline-block';
            document.getElementById('skip-btn').style.display = reviewMode ? 'none' : 'inline-block';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('answer').disabled = false;
        }

        function showTransitionScreen() {
            initialScore = score;
            document.getElementById('quiz').style.display = 'none';
            document.getElementById('transition').style.display = 'block';

            const percentage = Math.round((score / quizSize) * 100);
            document.getElementById('transition-score').textContent = `${percentage}%`;

            let title = 'Great Job!';
            if (percentage >= 90) title = 'Excellent Work!';
            else if (percentage >= 80) title = 'Great Job!';
            else if (percentage >= 70) title = 'Good Effort!';
            else if (percentage >= 60) title = 'Keep Practicing!';
            else title = 'Nice Try!';

            document.getElementById('transition-title').textContent = title;
            document.getElementById('transition-message').textContent = `You answered ${score} out of ${quizSize} questions correctly!`;
            document.getElementById('transition-review-info').textContent = `Let's review the ${mistakes.length} question${mistakes.length === 1 ? '' : 's'} you missed.`;
        }

        function startReview() {
            document.getElementById('transition').style.display = 'none';
            document.getElementById('quiz').style.display = 'block';
            startReviewMode();
        }

        function startReviewMode() {
            reviewMode = true;
            masteryTracker = {};
            savedMistakesForReview = [...mistakes]; // Save for potential re-review

            if (quizMode === 'verbs') {
                reviewQuestions = mistakes.map(m => ({
                    verb: m.verb,
                    english: m.english,
                    pronoun: m.pronoun,
                    answer: m.correct,
                    key: `${m.verb}-${m.pronoun}`,
                    type: 'verb'
                }));
            } else if (quizMode === 'pronouns') {
                // Direct object pronoun mode
                reviewQuestions = mistakes.map(m => ({
                    sentence: m.sentence,
                    verb: m.verb,
                    answer: m.correct,
                    key: `${m.sentence}-${m.answer}`,
                    type: 'pronoun'
                }));
            } else if (quizMode === 'indirect') {
                // Indirect object pronoun mode
                reviewQuestions = mistakes.map(m => ({
                    sentence: m.sentence,
                    verb: m.verb,
                    answer: m.correct,
                    key: `${m.sentence}-${m.answer}`,
                    type: 'indirect'
                }));
            } else {
                // Advanced mode - preserve the type from original mistake
                reviewQuestions = mistakes.map(m => ({
                    verb: m.verb,
                    english: m.english,
                    pronoun: m.pronoun,
                    sentence: m.sentence,
                    answer: m.correct,
                    key: m.type === 'verb' ? `${m.verb}-${m.pronoun}` : `${m.sentence}-${m.answer}`,
                    type: m.type
                }));
            }

            // Initialize mastery tracker
            reviewQuestions.forEach(q => {
                masteryTracker[q.key] = 0;
            });

            questions = [...reviewQuestions];
            currentQuestion = 0;
            displayQuestion();
        }

        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('answer').value.trim().toLowerCase();
            const correctAnswer = questions[currentQuestion].answer.toLowerCase();
            const feedback = document.getElementById('feedback');

            if (!userAnswer) {
                return;
            }

            const userNoAccent = removeAccents(userAnswer);
            const correctNoAccent = removeAccents(correctAnswer);
            const isCorrect = userAnswer === correctAnswer;
            const isPartial = !isCorrect && userNoAccent === correctNoAccent;

            if (reviewMode) {
                const key = questions[currentQuestion].key;

                if (isCorrect || isPartial) {
                    masteryTracker[key] = (masteryTracker[key] || 0) + 1;

                    if (isPartial) {
                        feedback.className = 'feedback partial';
                        feedback.innerHTML = `Correct! (Missing accent: ${questions[currentQuestion].pronoun} ${correctAnswer}) (${masteryTracker[key]}/2)<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                    } else {
                        feedback.className = 'feedback correct';
                        feedback.innerHTML = `Correct! ${questions[currentQuestion].pronoun} ${correctAnswer} (${masteryTracker[key]}/2)<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                    }

                    // If this is the first correct answer, add it back to the end randomly
                    if (masteryTracker[key] === 1 && questions.length > 1) {
                        const currentQ = questions[currentQuestion];
                        // Insert at a random position after current question
                        const insertPos = Math.floor(Math.random() * (questions.length - currentQuestion - 1)) + currentQuestion + 1;
                        questions.splice(insertPos, 0, {...currentQ});
                    }

                    // If mastered (correct twice), remove from review
                    if (masteryTracker[key] >= 2) {
                        questions = questions.filter(q => q.key !== key);
                        // Don't increment currentQuestion since we removed the item
                    }
                } else {
                    masteryTracker[key] = 0; // Reset on incorrect answer
                    feedback.className = 'feedback incorrect';
                    feedback.textContent = `Incorrect. The correct answer is: ${questions[currentQuestion].pronoun} ${correctAnswer}`;
                }
            } else {
                // Normal quiz mode
                if (isCorrect || isPartial) {
                    score++;
                    if (isPartial) {
                        feedback.className = 'feedback partial';
                        if (quizMode === 'verbs') {
                            feedback.innerHTML = `Correct! (Missing accent: ${questions[currentQuestion].pronoun} ${correctAnswer})<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                        } else {
                            feedback.innerHTML = `Correct! (Missing accent: ${correctAnswer})<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                        }
                    } else {
                        feedback.className = 'feedback correct';
                        if (quizMode === 'verbs') {
                            feedback.innerHTML = `Correct! ${questions[currentQuestion].pronoun} ${correctAnswer}<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                        } else {
                            feedback.innerHTML = `Correct! ${correctAnswer}<br><img src="images/Hello_Kitty.webp" alt="Hello Kitty">`;
                        }
                    }
                } else {
                    feedback.className = 'feedback incorrect';
                    if (questions[currentQuestion].type === 'verb') {
                        feedback.textContent = `Incorrect. The correct answer is: ${questions[currentQuestion].pronoun} ${correctAnswer}`;
                        mistakes.push({
                            verb: questions[currentQuestion].verb,
                            english: questions[currentQuestion].english,
                            pronoun: questions[currentQuestion].pronoun,
                            correct: correctAnswer,
                            given: userAnswer,
                            type: 'verb'
                        });
                    } else {
                        feedback.textContent = `Incorrect. The correct answer is: ${correctAnswer}`;
                        mistakes.push({
                            sentence: questions[currentQuestion].sentence,
                            verb: questions[currentQuestion].verb,
                            correct: correctAnswer,
                            given: userAnswer,
                            type: questions[currentQuestion].type
                        });
                    }
                }
            }

            // Show next button, hide submit/skip buttons
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            document.getElementById('answer').disabled = true;
        }

        function nextQuestion() {
            // In review mode, if the current question was mastered, it was already removed
            // so we don't increment. Otherwise, move to next question.
            if (!reviewMode) {
                currentQuestion++;
            } else {
                // Check if current question still exists and was mastered
                if (currentQuestion < questions.length) {
                    const key = questions[currentQuestion].key;
                    if (masteryTracker[key] < 2) {
                        currentQuestion++;
                    }
                    // If mastered (>=2), question was removed, don't increment
                }
            }
            displayQuestion();
        }

        function skipQuestion() {
            if (questions[currentQuestion].type === 'verb') {
                mistakes.push({
                    verb: questions[currentQuestion].verb,
                    english: questions[currentQuestion].english,
                    pronoun: questions[currentQuestion].pronoun,
                    correct: questions[currentQuestion].answer,
                    given: '(skipped)',
                    type: 'verb'
                });
            } else {
                mistakes.push({
                    sentence: questions[currentQuestion].sentence,
                    verb: questions[currentQuestion].verb,
                    correct: questions[currentQuestion].answer,
                    given: '(skipped)',
                    type: questions[currentQuestion].type
                });
            }
            currentQuestion++;
            displayQuestion();
        }

        function showResults() {
            // Clear mistakes if review was completed successfully
            const reviewCompleted = reviewMode && questions.length === 0;
            if (reviewCompleted) {
                mistakes = [];
            }

            // Save student progress
            saveStudentData(currentStudent);

            document.getElementById('quiz').style.display = 'none';
            document.getElementById('transition').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            if (reviewMode) {
                // Review results - also show score history
                const history = getScoreHistory(currentStudent);
                let historyHTML = '';

                if (history.length > 0) {
                    historyHTML = '<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;"><h3 style="color: #667eea; margin-bottom: 10px;">üìä Your Score History</h3>' +
                        history.slice(-10).reverse().map((h, i) => {
                            const date = new Date(h.date);
                            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            const isLatest = i === 0;
                            return `<div style="padding: 5px 0; color: #666; ${isLatest ? 'font-weight: bold; border-left: 3px solid #667eea; padding-left: 10px;' : ''}">${dateStr}: <strong style="color: ${h.percentage >= 80 ? '#28a745' : h.percentage >= 60 ? '#ffc107' : '#dc3545'}">${h.percentage}%</strong> (${h.score}/${h.total})${isLatest ? ' ‚Üê Latest' : ''}</div>`;
                        }).join('') + '</div>';
                }

                // Add progress summary for review completion
                let reviewProgressSummary = '';
                if (history.length >= 2) {
                    const recentScores = history.slice(-5);
                    const avgRecent = Math.round(recentScores.reduce((sum, h) => sum + h.percentage, 0) / recentScores.length);
                    const latestPercentage = history[history.length - 1].percentage;
                    reviewProgressSummary = `<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 10px; border-left: 4px solid #667eea;"><h3 style="color: #667eea; margin-bottom: 10px;">üìà Your Progress Summary</h3><p style="color: #333; margin: 5px 0;">Latest Quiz Score: <strong style="color: ${latestPercentage >= 80 ? '#28a745' : latestPercentage >= 60 ? '#ffc107' : '#dc3545'}">${latestPercentage}%</strong></p><p style="color: #333; margin: 5px 0;">Recent Average (last 5): <strong>${avgRecent}%</strong></p><p style="color: #333; margin: 5px 0;">Total Quizzes Taken: <strong>${history.length}</strong></p><button onclick="showGraphPage()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üìä View Score Graph</button></div>`;
                }

                if (reviewCompleted) {
                    document.getElementById('results-title').textContent = 'Review Complete!';
                    document.getElementById('score').innerHTML = '100%<br><img src="images/Kuromi_render.png" alt="Kuromi">';
                    document.getElementById('results-message').innerHTML = `You mastered all ${reviewQuestions.length} review question${reviewQuestions.length === 1 ? '' : 's'}!` + reviewProgressSummary + historyHTML;
                    document.getElementById('gaps-section').style.display = 'block';
                    document.getElementById('gaps-list').innerHTML = '<p style="color: #28a745; font-weight: bold; font-size: 18px;">üéâ Excellent! You\'ve mastered all the questions you missed!</p>';
                    document.getElementById('review-again-btn').style.display = 'none';
                } else {
                    // Review not completed, shouldn't normally happen
                    document.getElementById('results-title').textContent = 'Review Progress';
                    document.getElementById('score').innerHTML = 'In Progress<br><img src="images/Kuromi_render.png" alt="Kuromi">';
                    document.getElementById('results-message').innerHTML = 'Keep practicing!' + reviewProgressSummary + historyHTML;
                    document.getElementById('review-again-btn').style.display = 'none';
                }
            } else {
                // Initial quiz results
                const percentage = Math.round((score / quizSize) * 100);

                // Save score to history
                saveScoreHistory(currentStudent, score, quizSize);

                document.getElementById('results-title').textContent = 'Quiz Complete!';
                document.getElementById('score').innerHTML = `${percentage}%<br><img src="images/Kuromi_render.png" alt="Kuromi">`;

                // Generate improvement commentary and score history
                const history = getScoreHistory(currentStudent);
                let commentary = '';
                let historyHTML = '';

                if (history.length >= 2) {
                    const currentScore = history[history.length - 1];
                    const previousScore = history[history.length - 2];
                    const improvement = currentScore.percentage - previousScore.percentage;

                    if (improvement > 10) {
                        commentary = `<div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; margin: 20px 0; border-radius: 5px; color: #155724; font-weight: bold;">üéâ Great improvement! You're up ${improvement}% from your last quiz!</div>`;
                    } else if (improvement > 0) {
                        commentary = `<div style="padding: 15px; background: #d1ecf1; border-left: 4px solid #0c5460; margin: 20px 0; border-radius: 5px; color: #0c5460; font-weight: bold;">üëç Nice! You improved by ${improvement}% - keep it up!</div>`;
                    } else if (improvement === 0) {
                        commentary = `<div style="padding: 15px; background: #fff3cd; border-left: 4px solid #856404; margin: 20px 0; border-radius: 5px; color: #856404; font-weight: bold;">üìä Same score as last time. Keep practicing to improve!</div>`;
                    } else {
                        commentary = `<div style="padding: 15px; background: #f8d7da; border-left: 4px solid #721c24; margin: 20px 0; border-radius: 5px; color: #721c24; font-weight: bold;">üí™ Don't give up! Practice makes perfect!</div>`;
                    }

                    // Calculate overall trend
                    if (history.length >= 3) {
                        const last3 = history.slice(-3);
                        const avgLast3 = last3.reduce((sum, h) => sum + h.percentage, 0) / 3;
                        const firstHalf = history.slice(0, Math.floor(history.length / 2));
                        const avgFirst = firstHalf.reduce((sum, h) => sum + h.percentage, 0) / firstHalf.length;

                        if (avgLast3 > avgFirst + 10) {
                            commentary += `<div style="padding: 10px; background: #e7f3ff; border-radius: 5px; margin-top: 10px; color: #004085;">üìà Overall Trend: You're getting better! Keep up the great work!</div>`;
                        }
                    }
                }

                // Build score history display
                if (history.length > 0) {
                    historyHTML = '<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;"><h3 style="color: #667eea; margin-bottom: 10px;">üìä Your Score History</h3>' +
                        history.slice(-10).reverse().map((h, i) => {
                            const date = new Date(h.date);
                            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            const isLatest = i === 0;
                            return `<div style="padding: 5px 0; color: #666; ${isLatest ? 'font-weight: bold; border-left: 3px solid #667eea; padding-left: 10px;' : ''}">${dateStr}: <strong style="color: ${h.percentage >= 80 ? '#28a745' : h.percentage >= 60 ? '#ffc107' : '#dc3545'}">${h.percentage}%</strong> (${h.score}/${h.total})${isLatest ? ' ‚Üê Latest' : ''}</div>`;
                        }).join('') + '</div>';
                }

                // Add progress summary
                let progressSummary = '';
                if (history.length >= 2) {
                    const recentScores = history.slice(-5);
                    const avgRecent = Math.round(recentScores.reduce((sum, h) => sum + h.percentage, 0) / recentScores.length);
                    progressSummary = `<div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 10px; border-left: 4px solid #667eea;"><h3 style="color: #667eea; margin-bottom: 10px;">üìà Your Progress Summary</h3><p style="color: #333; margin: 5px 0;">Current Score: <strong style="color: ${percentage >= 80 ? '#28a745' : percentage >= 60 ? '#ffc107' : '#dc3545'}">${percentage}%</strong></p><p style="color: #333; margin: 5px 0;">Recent Average (last 5): <strong>${avgRecent}%</strong></p><p style="color: #333; margin: 5px 0;">Total Quizzes Taken: <strong>${history.length}</strong></p><button onclick="showGraphPage()" style="margin-top: 15px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üìä View Score Graph</button></div>`;
                }

                document.getElementById('results-message').innerHTML = `You got ${score} out of ${quizSize} correct!` + commentary + progressSummary + historyHTML;

                if (mistakes.length > 0) {
                    document.getElementById('gaps-section').style.display = 'block';
                    const gapsList = document.getElementById('gaps-list');
                    gapsList.innerHTML = '';

                    mistakes.forEach(mistake => {
                        const item = document.createElement('div');
                        item.className = 'gap-item';
                        item.innerHTML = `<strong>${mistake.verb || mistake.sentence}</strong>: ${mistake.pronoun || ''} ‚Üí ${mistake.correct} ${mistake.given !== '(skipped)' ? `(you answered: ${mistake.given})` : '(skipped)'}`;
                        gapsList.appendChild(item);
                    });
                    document.getElementById('review-again-btn').style.display = 'inline-block';
                } else {
                    // Student has mastered all verbs!
                    document.getElementById('gaps-section').style.display = 'block';
                    document.getElementById('gaps-list').innerHTML = '<p style="color: #28a745; font-weight: bold; font-size: 18px;">üéâ Perfect score! You\'ve mastered these verbs!</p>';
                    document.getElementById('review-again-btn').style.display = 'none';
                }
            }
        }

        function reviewAgain() {
            // Restore saved mistakes and restart review
            mistakes = [...savedMistakesForReview];
            currentQuestion = 0;
            score = 0;
            document.getElementById('results').style.display = 'none';
            document.getElementById('quiz').style.display = 'block';
            startReviewMode();
        }

        function restartQuiz() {
            currentQuestion = 0;
            score = 0;
            reviewMode = false;
            reviewQuestions = [];
            masteryTracker = {};
            // Keep mistakes from previous quiz to reinforce learning
            loadStudentData(currentStudent);
            generateQuestions();
            document.getElementById('quiz').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            displayQuestion();
        }

        document.getElementById('answer').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn.style.display === 'none') {
                    checkAnswer();
                } else {
                    nextQuestion();
                }
            }
        });

        // Show graph page
        function showGraphPage() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('graph-page').style.display = 'block';
            renderScoreGraph();
        }

        // Back to results from graph
        function backToResults() {
            document.getElementById('graph-page').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }

        // Render score graph using canvas
        function renderScoreGraph() {
            const history = getScoreHistory(currentStudent);
            if (history.length === 0) return;

            const canvas = document.getElementById('scoreChart');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = 600;
            canvas.height = 400;

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Graph dimensions
            const padding = 50;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;

            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Draw labels
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Score (%)', padding / 2, padding / 2);
            ctx.fillText('Quiz Number', canvas.width / 2, canvas.height - 10);

            // Draw Y-axis labels (0, 20, 40, 60, 80, 100)
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = canvas.height - padding - (i * graphHeight / 5);
                const label = i * 20;
                ctx.fillText(label + '%', padding - 10, y + 5);

                // Draw gridlines
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            // Plot data points
            const maxPoints = Math.min(history.length, 20); // Show last 20 quizzes
            const dataToPlot = history.slice(-maxPoints);
            const xStep = graphWidth / (maxPoints - 1 || 1);

            // Draw line
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            dataToPlot.forEach((h, i) => {
                const x = padding + (i * xStep);
                const y = canvas.height - padding - (h.percentage * graphHeight / 100);
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // Draw points
            dataToPlot.forEach((h, i) => {
                const x = padding + (i * xStep);
                const y = canvas.height - padding - (h.percentage * graphHeight / 100);

                // Point circle
                ctx.fillStyle = h.percentage >= 80 ? '#28a745' : h.percentage >= 60 ? '#ffc107' : '#dc3545';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();

                // Point border
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // X-axis labels (quiz number)
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                const quizNum = history.length - maxPoints + i + 1;
                ctx.fillText(quizNum, x, canvas.height - padding + 20);
            });

            // Generate statistics
            const statsDiv = document.getElementById('graph-stats');
            const percentages = history.map(h => h.percentage);
            const avgScore = Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length);
            const highScore = Math.max(...percentages);
            const lowScore = Math.min(...percentages);
            const recentAvg = Math.round(dataToPlot.map(h => h.percentage).reduce((a, b) => a + b, 0) / dataToPlot.length);

            // Calculate trend
            let trend = 'Stable';
            let trendColor = '#ffc107';
            if (history.length >= 3) {
                const recent3 = history.slice(-3).map(h => h.percentage);
                const older3 = history.slice(-6, -3).map(h => h.percentage);
                if (older3.length > 0) {
                    const recentAvg3 = recent3.reduce((a, b) => a + b, 0) / recent3.length;
                    const olderAvg3 = older3.reduce((a, b) => a + b, 0) / older3.length;
                    if (recentAvg3 > olderAvg3 + 5) {
                        trend = 'Improving! üìà';
                        trendColor = '#28a745';
                    } else if (recentAvg3 < olderAvg3 - 5) {
                        trend = 'Needs Practice üìâ';
                        trendColor = '#dc3545';
                    }
                }
            }

            statsDiv.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 15px;">Statistics</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="color: #666; font-size: 14px;">Overall Average</div>
                        <div style="font-size: 28px; font-weight: bold; color: #667eea;">${avgScore}%</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="color: #666; font-size: 14px;">Recent Average</div>
                        <div style="font-size: 28px; font-weight: bold; color: #667eea;">${recentAvg}%</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="color: #666; font-size: 14px;">Highest Score</div>
                        <div style="font-size: 28px; font-weight: bold; color: #28a745;">${highScore}%</div>
                    </div>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <div style="color: #666; font-size: 14px;">Lowest Score</div>
                        <div style="font-size: 28px; font-weight: bold; color: #dc3545;">${lowScore}%</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: center;">
                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Trend</div>
                    <div style="font-size: 24px; font-weight: bold; color: ${trendColor};">${trend}</div>
                </div>
            `;
        }

        // Initialize - show welcome screen
        // No auto-loading, wait for user to select student and mode

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/spanishtudor/service-worker.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker registration failed:', err));
            });
        }
    </script>
</body>
</html>